{% extends 'base.html.twig' %}

{% block title %}Rechercher des trajets{% endblock %}

{% block body %}
<div style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem;">Rechercher des trajets disponibles</h1>

    {% if error %}
        <div style="background: #fef2f2; border: 1px solid #f87171; color: #dc2626; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px;">
            {{ error|raw }}
        </div>
    {% endif %}

    <!-- Formulaire de recherche -->
    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem;">
        <form method="post" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div>
                <label for="ecoleId" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">École *</label>
                <select id="ecoleId" name="ecoleId" style="width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 0.5rem 0.75rem;" required>
                    <option value="">Sélectionnez une école</option>
                    {% for ecole in ecoles %}
                        <option value="{{ ecole.id }}" {% if ecoleId == ecole.id %}selected{% endif %}>
                            {{ ecole.nom }} - {{ ecole.ville }} ({{ ecole.codePostal }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="date" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Date *</label>
                <input type="date" id="date" name="date" value="{{ dateRecherche }}" style="width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 0.5rem 0.75rem;" required>
            </div>
            <div style="display: flex; align-items: end;">
                <button type="submit" style="width: 100%; padding: 0.5rem 1rem; border-radius: 4px; background: #2563eb; color: white; border: none; cursor: pointer; hover: background: #1d4ed8;">
                    Rechercher
                </button>
            </div>
        </form>
    </div>

    <!-- Résultats -->
    {% if trajets is not empty %}
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">
                {{ trajets|length }} trajet(s) disponible(s) 
                {% if ecoleId %}
                    pour {{ ecoles[ecoleId - 1].nom }}
                {% endif %}
                le {{ dateRecherche|date('d/m/Y') }}
            </h2>
            
            <div style="display: grid; gap: 1rem;">
                {% for trajet in trajets %}
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; hover: box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <h3 style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem;">Trajet #{{ trajet.id }}</h3>
                                <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.875rem;">
                                    <p><strong>Départ :</strong> {{ trajet.pointDepart }}</p>
                                    <p><strong>Arrivée :</strong> {{ trajet.pointArrivee }}</p>
                                    <p><strong>Date :</strong> {{ trajet.dateDepart|date('d/m/Y') }}</p>
                                    <p><strong>Heure départ :</strong> {{ trajet.heureDepart }}</p>
                                    <p><strong>Heure arrivée :</strong> {{ trajet.heureArrivee }}</p>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.875rem;">
                                    <p><strong>Places disponibles :</strong> 
                                        <span style="font-weight: bold; color: #16a34a;">{{ trajet.nombrePlaces }}</span>
                                    </p>
                                    <p><strong>Prix :</strong> 
                                        <span style="font-weight: bold; color: #2563eb;">{{ trajet.prix }}€</span>
                                    </p>
                                    <p><strong>Statut :</strong> 
                                        <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; 
                                            {% if trajet.statut == 'disponible' %}background: #dcfce7; color: #166534;
                                            {% elseif trajet.statut == 'en_cours' %}background: #fef3c7; color: #92400e;
                                            {% elseif trajet.statut == 'termine' %}background: #f3f4f6; color: #374151;
                                            {% else %}background: #fee2e2; color: #991b1b;{% endif %}">
                                            {{ trajet.statut|upper }}
                                        </span>
                                    </p>
                                    {% if trajet.description %}
                                        <p><strong>Description :</strong> {{ trajet.description }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {% if trajet.enfantsIds is not empty %}
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                                <p style="font-size: 0.875rem; color: #6b7280;">
                                    <strong>Enfants dans la voiture :</strong> {{ trajet.enfantsIds|length }}
                                </p>
                            </div>
                        {% endif %}
                        
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button style="padding: 0.5rem 1rem; border-radius: 4px; background: #16a34a; color: white; border: none; cursor: pointer; font-size: 0.875rem; hover: background: #15803d;">
                                Réserver
                            </button>
                            <a href="{{ path('chat_conversation', {'trajetId': trajet.id, 'destinataireId': trajet.conducteurId}) }}" 
                               style="padding: 0.5rem 1rem; border-radius: 4px; background: #2563eb; color: white; text-decoration: none; font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem; hover: background: #1d4ed8;">
                                <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                Contacter le conducteur
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% elseif ecoleId and dateRecherche %}
        <div style="background: #fefce8; border: 1px solid #facc15; color: #ca8a04; padding: 0.75rem; border-radius: 4px;">
            <p>Aucun trajet disponible pour cette école et cette date.</p>
            <p style="margin-top: 0.5rem;">
                <a href="{{ path('trajet_ajouter') }}" style="color: #2563eb; text-decoration: underline;">
                    Créer un trajet pour cette école
                </a>
            </p>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Définir la date minimale à aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').min = today;
});
</script>
{% endblock %} 